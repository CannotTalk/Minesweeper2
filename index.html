    <script>
        // ... (他の定数や変数宣言はそのまま) ...

        let revealedNonMineCount = 0;
        let gameStarted = false;

        // --- Get DOM Elements ---
        const boardElement = document.getElementById('board');
        const resetButton = document.getElementById('reset-button');
        // ... (他の要素取得はそのまま) ...
        const popupOverlay = document.getElementById('popup-overlay');
        const hideSwitch = document.getElementById('hide-switch');
        const oddEvenSwitch = document.getElementById('odd-even-switch');
        const areaValueSwitch = document.getElementById('area-value-switch');
        const numberSwitch = document.getElementById('number-switch'); // ★ 新しいスイッチ要素

        // --- Initial Settings ---
        let enableHide = hideSwitch.checked;
        let enableOddEven = oddEvenSwitch.checked;
        let enableAreaValue = areaValueSwitch.checked;
        let enableNumbers = numberSwitch.checked; // ★ 新しい設定変数

        // --- Event Listeners ---
        // ... (他のリスナーはそのまま) ...
        numberSwitch.addEventListener('change', handleSettingChange); // ★ 新しいスイッチのリスナー
        hideSwitch.addEventListener('change', handleSettingChange);
        oddEvenSwitch.addEventListener('change', handleSettingChange);
        areaValueSwitch.addEventListener('change', handleSettingChange);

        // --- Popup Functions ---
        function openPopup() { /* ... no change ... */ }
        function closePopup() { /* ... no change ... */ }

        function handleSettingChange() {
            // Update all settings from their switches
            enableHide = hideSwitch.checked;
            enableOddEven = oddEvenSwitch.checked;
            enableAreaValue = areaValueSwitch.checked;
            enableNumbers = numberSwitch.checked; // ★ 設定変数を更新
            resetGame();
        }

        // --- Game Logic Functions ---
        function resetGame() { /* ... no change ... */ }

        function createBoard() {
            // ... (ボード初期化、要素生成、リスナー設定はほぼ同じ) ...
            // Reset flags inside the loop for clarity upon board creation
            for (let i = 0; i < gridSize; i++) {
                 board[i] = [];
                 for (let j = 0; j < gridSize; j++) {
                     board[i][j] = {
                         isMine: false, isRevealed: false, isFlagged: false,
                         isHide: false, isOddEven: false, isAreaValue: false, // Reset flags
                         oddEvenValue: null, areaValue: null, adjacentMines: 0,
                         element: document.createElement('div')
                     };
                     // ... (element setup and listeners) ...
                      const square = board[i][j];
                      const squareElement = square.element;
                      squareElement.classList.add('square', 'hidden');
                      squareElement.dataset.row = i; squareElement.dataset.col = j;
                      squareElement.addEventListener('click', () => handleSquareClick(i, j));
                      squareElement.addEventListener('contextmenu', (event) => { event.preventDefault(); handleRightClick(i, j); });
                      // Touch listener
                      let pressTimer;
                      squareElement.addEventListener('touchstart', (event) => {
                          pressTimer = setTimeout(() => { event.preventDefault(); handleRightClick(i, j); }, 500);
                      }, { passive: false });
                      squareElement.addEventListener('touchend', () => { clearTimeout(pressTimer); });
                      squareElement.addEventListener('touchmove', () => { clearTimeout(pressTimer); });
                      boardElement.appendChild(squareElement);
                 }
             }
            plantMines();
            calculateAdjacentMines();
            applySpecialSquares(); // ★ この関数が変更される
            updateMinesLeftDisplay();
        }

        function plantMines() { /* ... no change ... */ }
        function calculateAdjacentMines() { /* ... no change ... */ }

        // ★★★ applySpecialSquares 関数を大幅に変更 ★★★
        function applySpecialSquares() {
            const potentialNumberSquares = []; // 数字が表示される可能性のあるマス (Mineでなく、adjacent > 0)
            // Reset flags explicitly before applying new logic
            for (let i = 0; i < gridSize; i++) {
                for (let j = 0; j < gridSize; j++) {
                    const square = board[i][j];
                    square.isHide = false;
                    square.isOddEven = false;
                    square.isAreaValue = false;
                    square.oddEvenValue = null;
                    square.areaValue = null;
                    if (!square.isMine && square.adjacentMines > 0) {
                        potentialNumberSquares.push({ r: i, c: j });
                    }
                }
            }
            potentialNumberSquares.sort(() => Math.random() - 0.5); // Shuffle for variety

            const assignedSpecial = new Set(); // Keep track of assigned special squares
            const totalSquares = gridSize * gridSize; // For probability calculation when enableNumbers is true

            if (!enableNumbers) {
                // --- 数字マスを生成しない場合 ---
                // 1. AreaValue を可能な限り適用
                if (enableAreaValue) {
                    for (const { r, c } of potentialNumberSquares) {
                        const k = `${r}-${c}`;
                        if (!assignedSpecial.has(k) && !hasNeighborOfType(r, c, 'isAreaValue')) {
                            const square = board[r][c];
                            square.isAreaValue = true;
                            square.isHide = true; // Special implies Hide
                            if (square.adjacentMines <= 3) square.areaValue = '-3';
                            else if (square.adjacentMines <= 6) square.areaValue = '4-6';
                            else square.areaValue = '7+';
                            assignedSpecial.add(k);
                        }
                    }
                }
                // 2. OddEven を可能な限り適用 (AreaValue にならなかったもの)
                if (enableOddEven) {
                    for (const { r, c } of potentialNumberSquares) {
                        const k = `${r}-${c}`;
                        const square = board[r][c];
                        // Check if not already assigned, requires > 1 adjacent mine, and no OddEven neighbors
                        if (!assignedSpecial.has(k) && square.adjacentMines > 1 && !hasNeighborOfType(r, c, 'isOddEven')) {
                            square.isOddEven = true;
                            square.isHide = true; // Special implies Hide
                            square.oddEvenValue = square.adjacentMines % 2 === 0 ? 'Ev' : 'Od';
                            assignedSpecial.add(k);
                        }
                    }
                }
                // 3. 残りの数字マス候補をすべて Hide マスにする
                //    enableHide の設定に関わらず、数字を表示しない設定が優先されるため、「・」を表示
                for (const { r, c } of potentialNumberSquares) {
                    const k = `${r}-${c}`;
                    if (!assignedSpecial.has(k)) {
                         board[r][c].isHide = true;
                         // Note: We don't need to add to assignedSpecial here unless tracking simple hides specifically matters later
                    }
                }

            } else {
                // --- 数字マスを生成する場合 (従来の確率ベースのロジック) ---
                 // Apply Area Value first based on probability
                if (enableAreaValue) {
                    const maxArea = Math.floor(totalSquares * maxAreaValueRate);
                    let count = 0;
                    for (const { r, c } of potentialNumberSquares) {
                        if (count >= maxArea) break;
                         const key = `${r}-${c}`;
                         if (!assignedSpecial.has(key) && !hasNeighborOfType(r, c, 'isAreaValue')) {
                             const square = board[r][c];
                             square.isAreaValue = true;
                             square.isHide = true;
                             if (square.adjacentMines <= 3) square.areaValue = '-3';
                             else if (square.adjacentMines <= 6) square.areaValue = '4-6';
                             else square.areaValue = '7+';
                             assignedSpecial.add(key);
                             count++;
                         }
                     }
                }
                // Apply Odd/Even next based on probability
                if (enableOddEven) {
                    const maxOddEven = Math.floor(totalSquares * maxOddEvenRate);
                    let count = 0;
                     for (const { r, c } of potentialNumberSquares) {
                        if (count >= maxOddEven) break;
                        const key = `${r}-${c}`;
                         const square = board[r][c];
                        if (!assignedSpecial.has(key) && square.adjacentMines > 1 && !hasNeighborOfType(r, c, 'isOddEven')) {
                             square.isOddEven = true;
                             square.isHide = true;
                             square.oddEvenValue = square.adjacentMines % 2 === 0 ? 'Ev' : 'Od';
                             assignedSpecial.add(key);
                             count++;
                         }
                    }
                }
                // Apply simple Hide last (based on probability) only if enabled
                if (enableHide) {
                     const hideRate = Math.random() * (maxHideRate - minHideRate) + minHideRate;
                     const maxHide = Math.floor(totalSquares * hideRate);
                     let count = 0;
                     for (const { r, c } of potentialNumberSquares) {
                          if (count >= maxHide) break;
                          const key = `${r}-${c}`;
                          if (!assignedSpecial.has(key)) { // Only hide if not already a special type
                              board[r][c].isHide = true;
                              // assignedSpecial.add(key); // Optionally track simple hides too
                              count++;
                          }
                      }
                  }
                  // Squares in potentialNumberSquares not marked as isHide=true will display numbers
            }
        }

        function hasNeighborOfType(r, c, key) { /* ... no change ... */ }
        function handleSquareClick(r, c) { /* ... no change ... */ }
        function revealMine(r, c) { /* ... no change ... */ }
        function revealSquare(r, c) { /* ... no change ... */ }

        // renderSquareContent は isHide, isOddEven, isAreaValue フラグを見ているので変更不要
        function renderSquareContent(sq) { /* ... no change ... */ }

        function handleRightClick(r, c) { /* ... no change ... */ }
        function updateMinesLeftDisplay() { /* ... no change ... */ }
        function checkWinCondition() { /* ... no change ... */ }
        function endGame(isWin) { /* ... no change ... */ }
        function revealAllMines(showContent) { /* ... no change ... */ }
        function updateTimer() { /* ... no change ... */ }
        function updateTimerDisplay() { /* ... no change ... */ }
        function revealNonMines() { /* ... no change ... */ }
        function revealAll() { /* ... no change ... */ }

        // --- Initial Setup ---
        createBoard();

    </script>
</body>
</html>
